<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Test</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { padding: 20px; }
        .test-container { max-width: 1000px; margin: 0 auto; }
        .button-row { margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .console-output { 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            font-family: monospace; 
            height: 200px; 
            overflow-y: auto; 
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Final Comprehensive Test</h1>
        
        <div class="button-row">
            <button onclick="testFullWorkflow()">🚀 Test Full Demo Workflow</button>
            <button onclick="testScoreDisplayOnly()">📊 Test Score Display Only</button>
            <button onclick="testApiConnections()">🔗 Test API Connections</button>
            <button onclick="clearResults()">🧹 Clear Results</button>
        </div>
        
        <div class="console-output" id="console-output">Console output will appear here...</div>
        
        <!-- Demo form similar to the main page -->
        <div class="demo-section">
            <h3>Demo Wallet Input</h3>
            <div class="input-group">
                <input id="wallet-address-input" type="text" placeholder="Wallet address" />
                <button id="demo-wallet-btn">Try Demo Wallet</button>
            </div>
        </div>
        
        <!-- Processing container -->
        <div id="processing-container" class="processing-container" style="display: none;">
            <div class="processing-spinner"></div>
            <div class="processing-text">Processing Wallet Data...</div>
            <div class="processing-step" id="processing-step">Initializing analysis...</div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>
        
        <!-- Results container -->
        <div id="import-results" class="import-results" style="display: none;"></div>
    </div>

    <script type="module">
        import { fetchWalletAnalysis, fetchCreditScoreExplanation, fetchWalletGraph } from './js/services/apiService.js';
        import { CreditScoreDisplay } from './js/components/CreditScoreDisplay.js';
        import { RawDataVisualizer } from './js/components/RawDataVisualizer.js';
        
        const consoleOutput = document.getElementById('console-output');
        const creditDisplay = new CreditScoreDisplay();
        const rawDisplay = new RawDataVisualizer();
        
        // Capture console output
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            const output = `${timestamp} ${prefix} ${message}\n`;
            consoleOutput.textContent += output;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }
        
        window.testFullWorkflow = async function() {
            log('🚀 Starting full demo workflow test...');
            clearResults();
            
            try {
                const demoAddress = '0x57ef012861c4937a76b5d6061be800199a2b9100';
                document.getElementById('wallet-address-input').value = demoAddress;
                log(`Setting demo address: ${demoAddress}`);
                
                log('Fetching complete wallet analysis...');
                const result = await fetchWalletAnalysis(demoAddress);
                
                log('Analysis completed successfully!', 'success');
                log(`Has wallet graph: ${!!result.walletGraph}`);
                log(`Has credit score: ${!!result.creditScore}`);
                log(`Errors: ${result.errors.length}`);
                
                if (result.creditScore && result.creditScore.status === 'success') {
                    log('Displaying credit score results...', 'success');
                    creditDisplay.displayCreditScoreResults(result.creditScore);
                } else if (result.walletGraph) {
                    log('Displaying raw wallet data...', 'success');
                    rawDisplay.displayRawData(result.walletGraph);
                } else {
                    log('No valid data to display', 'error');
                }
                
                log('Full workflow completed successfully! 🎉', 'success');
                
            } catch (error) {
                log(`Full workflow failed: ${error.message}`, 'error');
            }
        };
        
        window.testScoreDisplayOnly = async function() {
            log('📊 Testing score display with sample data...');
            clearResults();
            
            const sampleScore = {
                status: 'success',
                score: 679.39,
                explanation: 'This wallet shows positive credit behavior with good payment history.',
                processing_time: '2.1s',
                tokens_used: 1200,
                error_message: null,
                nodes: [],
                edges: []
            };
            
            try {
                log('Displaying sample score data...');
                creditDisplay.displayCreditScoreResults(sampleScore);
                log('Score display completed successfully!', 'success');
            } catch (error) {
                log(`Score display failed: ${error.message}`, 'error');
            }
        };
        
        window.testApiConnections = async function() {
            log('🔗 Testing API connections...');
            
            try {
                log('Testing wallet graph API...');
                const walletData = await fetchWalletGraph('0x57ef012861c4937a76b5d6061be800199a2b9100', 5);
                log(`Wallet API success - got ${walletData.wallets?.length || 0} wallets`, 'success');
                
                log('Testing credit score API...');
                const scoreData = await fetchCreditScoreExplanation('0x1_0x57ef012861c4937a76b5d6061be800199a2b9100');
                log(`Credit API success - score: ${scoreData.score}`, 'success');
                
                log('All API connections successful! 🎉', 'success');
                
            } catch (error) {
                log(`API connection failed: ${error.message}`, 'error');
            }
        };
        
        window.clearResults = function() {
            consoleOutput.textContent = 'Console cleared...\n';
            document.getElementById('import-results').style.display = 'none';
            document.getElementById('import-results').innerHTML = '';
        };
        
        // Set up demo button (mimicking the main functionality)
        document.getElementById('demo-wallet-btn').addEventListener('click', () => {
            log('Demo button clicked!');
            testFullWorkflow();
        });
        
        log('Final test page loaded and ready! 🚀');
    </script>
</body>
</html>
